<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Shopping Cart</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <style>
        .stickyheader
        {
            /* add sticky header*/
            position: sticky;
            /* position the sticky header to be on top of the viewport*/
            top: 0;
            /* add padding for the header*/
            padding: 10px 16px;
            /* Make sure the heading will be on top of other content when scrolling*/
            z-index: 100;
        }
        .cart-header 
        {
            padding: 15px;
            background-color: white;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            gap: 20px;
            align-items: center;
        }
        .cart-item-row 
        {
            border: 1px solid #dee2e6;
            margin-bottom: 10px;
            background-color: white;
            padding: 15px;
            /* Dùng Flexbox để căn chỉnh các thành phần trong 1 sản phẩm */
            display: flex;
            align-items: center;
        }
        .thumbnail 
        {
            width: 80px;
            height: 80px;
            background-color: #f2f2f2;
            border: 1px solid #ccc;
            margin-right: 15px;
            display: flex;
        }
        .product-count 
        {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-right: 15px;
        }
        .product-count input {
            width: 60px;
            text-align: center;
        }
        .summary-box 
        {
            border: 1px solid #dee2e6;
            padding: 15px;
            text-align: center;
            background-color: #fff;
            display: grid;
        }
        .empty-cart {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <header class="cart-header">
        <a class="navbar-brand me-3" href="/"><img src="https://images.unsplash.com/photo-1763929272741-56e50999033f?w=500&auto=format&fit=crop&q=60&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NDZ8fHJhbmRvbSUyMGxvZ298ZW58MHx8MHx8fDA%3D" height="40" width="40" alt="logo"></a>
        <form class="d-flex flex-grow-1 me-3" role="search" method="POST" action="/DProject_ProductList">
            <input class="form-control me-2" type="search" placeholder="Search bar" aria-label="Search" name="search">
            <button class="btn btn-outline-success" type="submit">Search</button>
        </form>
        <div class="d-flex me-2">
            <% if (user) { %>
                <span class="navbar-text me-2">
                    <strong><%= user.username %></strong>
                </span>
                <form method="POST" action="/logout" class="d-inline">
                    <button type="submit" class="btn btn-outline-danger">Logout</button>
                </form>
            <% } else { %>
                <a href="/DProject_Login" class="btn btn-outline-secondary">Login / Signup</a>
            <% } %>
        </div>
    </header>
    <main class="container-fluid p-5">
        <h2 class="mb-4">Your Shopping Cart</h2>
        
        <% if (cartItems && cartItems.length > 0) { %>
            <div id="cart-items-container">
                <% cartItems.forEach(item => { %>
                    <div class="row cart-item-row" data-cart-id="<%= item.cart_id %>" data-price="<%= item.prd_price %>">
                        <div class="col-md-1">
                            <div class="thumbnail">
                                <img src="<%= item.prd_image %>" alt="<%= item.prd_name %>" class="img-thumbnail img-fluid">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <p class="mb-0"><strong><%= item.prd_name %></strong></p>
                            <p class="text-muted mb-0">Code: <%= item.prd_code %></p>
                        </div>
                        <div class="col-md-3">
                            <p class="mb-0"><%= item.prd_description %></p>
                            <p class="text-muted mb-0">Stock: <%= item.prd_stock %> available</p>
                        </div>
                        <div class="col-md-2 product-count">
                            <button class="btn btn-sm btn-outline-secondary" onclick="updateQuantity(<%= item.cart_id %>, <%= item.quantity %>, -1, <%= item.prd_price %>)">-</button>
                            <input type="text" value="<%= item.quantity %>" class="form-control form-control-sm quantity-input" id="qty-<%= item.cart_id %>" readonly>
                            <button class="btn btn-sm btn-outline-secondary" onclick="updateQuantity(<%= item.cart_id %>, <%= item.quantity %>, 1, <%= item.prd_price %>)">+</button>
                        </div>
                        <div class="col-md-1">
                            <p class="mb-0"><strong>Total:</strong></p>
                            <p class="text-success fw-bold" id="item-total-<%= item.cart_id %>">$<%= (item.prd_price * item.quantity).toFixed(2) %></p>
                        </div>
                        <div class="col-md-1">
                            <button class="btn btn-sm btn-outline-danger" onclick="removeItem(<%= item.cart_id %>)">Remove</button>
                        </div>
                    </div>
                <% }) %>
            </div>
        <% } else { %>
            <div class="empty-cart" id="empty-cart-message">
                <i class="bi bi-cart-x" style="font-size: 4rem;"></i>
                <h3>Your cart is empty</h3>
                <p>Add some products to get started!</p>
                <a href="/DProject_ProductList" class="btn btn-primary">Shop Now</a>
            </div>
        <% } %>
    </main>  
    
    <% if (cartItems && cartItems.length > 0) { %>
    <footer class="container-fluid p-5" id="cart-footer">
        <div class="row align-items-stretch">          
            <div class="summary-box col-md-3">
                <strong>Total Items: <span id="total-items"><%= cartSummary.totalItems %></span></strong>
            </div>          
            <div class="summary-box col-md-4">
                <strong>Subtotal: $<span id="subtotal"><%= cartSummary.subtotal %></span></strong>
                <p>Shipping: $<span id="shipping"><%= cartSummary.shipping %></span></p>
                <p class="text-success fw-bold fs-5">Total: $<span id="total"><%= cartSummary.total %></span></p>
            </div>
            <div class="summary-box col-md-2">
                <button class="btn btn-outline-warning" onclick="clearCart()">
                    Clear cart
                </button>
            </div>    
            <div class="summary-box col-md-3">
                <button class="btn btn-outline-success btn-lg" onclick="proceedToCheckout()">
                    Proceed to checkout
                </button>
            </div>
        </div>
    </footer>
    <% } %>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <script>
        // Update quantity, apply async and await
        async function updateQuantity(cartId, currentQty, change, price) {
            const newQty = currentQty + change;
            
            // Don't allow quantity below 1
            if (newQty < 1) {
                if (confirm('Do you want to remove this item from cart?')) {
                    removeItem(cartId);
                }
                return;
            }
            //wait for the response from the server about updating the cart quantity, use AJAX request fetch for only updating the quantity
            const response = await fetch('/cart/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    cart_id: cartId,
                    quantity: newQty
                })
            });

            const data = await response.json();
            //if update success->
            if (data.success) {
                // Update the quantity input
                document.getElementById(`qty-${cartId}`).value = newQty;
                
                // Update the item total
                const itemTotal = (price * newQty).toFixed(2);
                document.getElementById(`item-total-${cartId}`).textContent = `$${itemTotal}`;
                
                // Update the quantity onclick attribute for next click
                const row = document.querySelector(`[data-cart-id="${cartId}"]`);
                const minusBtn = row.querySelector('.product-count button:first-child');
                const plusBtn = row.querySelector('.product-count button:last-child');
                
                minusBtn.setAttribute('onclick', `updateQuantity(${cartId}, ${newQty}, -1, ${price})`);
                plusBtn.setAttribute('onclick', `updateQuantity(${cartId}, ${newQty}, 1, ${price})`);
                
                // Update cart summary
                if (data.cartSummary) {
                    document.getElementById('total-items').textContent = data.cartSummary.totalItems;
                    document.getElementById('subtotal').textContent = data.cartSummary.subtotal;
                    document.getElementById('total').textContent = data.cartSummary.total;
                }
            } else {
                alert(data.message || 'Failed to update quantity');
            }
        }

        // Remove item from cart
        async function removeItem(cartId) {
            if (!confirm('Are you sure you want to remove this item from your cart?')) {
                return;
            }

            const response = await fetch('/cart/remove', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    cart_id: cartId
                })
            });

            const data = await response.json();

            if (data.success) {
                // Remove the item row from DOM
                const itemRow = document.querySelector(`[data-cart-id="${cartId}"]`);
                itemRow.remove();
                
                // Check if cart is now empty
                const remainingItems = document.querySelectorAll('.cart-item-row').length;
                if (remainingItems === 0) {
                    // Reload page to show empty cart message
                    location.reload();
                } else {
                    // Recalculate totals
                    recalculateTotals();
                }
            } else {
                alert(data.message || 'Failed to remove item');
            }
        }

        // Clear entire cart
        async function clearCart() {
            if (!confirm('Are you sure you want to clear your entire cart?')) {
                return;
            }

            const response = await fetch('/cart/clear', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            const data = await response.json();

            if (data.success) {
                // Reload page to show empty cart
                location.reload();
            } else {
                alert(data.message || 'Failed to clear cart');
            }
        }

        // Recalculate totals (used after removing item)
        function recalculateTotals() {
            let totalItems = 0;
            let subtotal = 0;

            document.querySelectorAll('.cart-item-row').forEach(row => {
                const quantity = parseInt(row.querySelector('.quantity-input').value);
                const price = parseFloat(row.getAttribute('data-price'));
                
                totalItems += quantity;
                subtotal += price * quantity;
            });

            const shipping = 5;
            const total = subtotal + shipping;

            document.getElementById('total-items').textContent = totalItems;
            document.getElementById('subtotal').textContent = subtotal.toFixed(2);
            document.getElementById('total').textContent = total.toFixed(2);
        }

        // Proceed to checkout
        function proceedToCheckout() {
            const proceed = confirm("Are you sure you want to proceed to checkout?");
            
            if (proceed) {
                window.location.href = "/DProject_Checkout";
            }
        }
    </script>
</body>
</html>
